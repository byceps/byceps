{% extends 'layout/admin/base.html' %}
{% from 'macros/datetime.html' import render_datetime %}
{% from 'macros/icons.html' import render_icon %}
{% from 'macros/shop_order_admin.html' import render_order_link %}
{% from 'macros/ticketing_admin.html' import render_ticket_flag_revoked, render_ticket_flag_user_checked_in %}
{% from 'macros/user_admin.html' import render_user_admin_link, render_user_avatar_20_and_link %}
{% from 'macros/user_avatar.html' import render_user_avatar_image_with_fallback %}
{% set current_page = 'ticketing_admin' %}
{% set current_page_party = party %}
{% set title = 'Ticket %s - Ticketing'|format(ticket.code) %}

{% block head %}
    <style>
      .user-microcard {
        display: flex;
      }

      .user-microcard-avatar {
        height: 2.5rem;
        margin-right: 0.4rem;
        width: 2.5rem;
      }

      .user-microcard-names {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        white-space: nowrap;
      }

      .managed-by {
        margin-top: 0.25rem;
      }
    </style>
{% endblock %}

{% macro render_user_microcard(user) -%}
<div class="user-microcard">
  <div class="user-microcard-avatar">
    <div class="avatar">{{ render_user_avatar_image_with_fallback(user) }}</div>
  </div>
  <div class="user-microcard-names">
    <div class="user-microcard-screen-name">{{ render_user_admin_link(user) }}</div>
    <div class="user-microcard-full-name">{{ user.detail.full_name }}</div>
  </div>
</div>
{%- endmacro %}

{% block body %}

  <nav class="breadcrumbs">
    <ol>
      <li>Ticketing</li>
      <li>{{ party.title }}</li>
    </ol>
  </nav>
  <h1>
    {{- render_icon('ticket') }} {{ ticket.code }}
    {%- if ticket.revoked %} {{ render_ticket_flag_revoked() }}{% endif -%}
    {%- if ticket.user_checked_in %} {{ render_ticket_flag_user_checked_in() }}{% endif -%}
  </h1>

  <table class="index">
    <tr>
      <th>ID</th>
      <td>
        {{ ticket.id }}
        <input id="ticket-id-field" value="{{ ticket.id }}" style="position: fixed; top: -1000px;" readonly>
        <button id="ticket-id-copy-trigger" data-field-id="ticket-id-field" class="button button--icon-only" title="In die Zwischenablage kopieren">{{ render_icon('clipboard') }}</button>
      </td>
    </tr>
    <tr>
      <th>Bundle</th>
      <td>
        {%- if ticket.bundle_id %}
        <a href="{{ url_for('.view_bundle', bundle_id=ticket.bundle_id) }}">Bundle</a>
        {%- else %}
        {{ 'eigenst√§ndig'|dim }}
        {%- endif %}
      </td>
    </tr>
    <tr>
      <th>Erstellt</th>
      <td>{{ render_datetime(ticket.created_at) }}</td>
    </tr>
    <tr>
      <th>Besitzer/in</th>
      <td>{{ render_user_microcard(ticket.owned_by) }}</td>
    </tr>
    <tr>
      <th>Bestellung</th>
      <td>{{ render_order_link(order) if order else None|fallback('nicht hinterlegt') }}</td>
    </tr>
    <tr>
      <th>Kategorie</th>
      <td>{{ ticket.category.title }}</td>
    </tr>
    <tr>
      <th>Sitzplatz</th>
      <td>
        {%- if ticket.occupied_seat -%}
        {{ ticket.occupied_seat.label }}
        {%- else -%}
        {{ 'keiner'|dim }}
        {%- endif -%}
        <div class="managed-by">{{ 'verwaltet durch'|dim  }} {{ render_user_avatar_20_and_link(ticket.get_seat_manager()) }}</div>
      </td>
    </tr>
    <tr>
      <th>Nutzer/in</th>
      <td>
        {%- if ticket.used_by -%}
        {{ render_user_microcard(ticket.used_by) }}
        {%- else -%}
        {{ 'keine/r'|dim }}
        {%- endif -%}
        <div class="managed-by">{{ 'verwaltet durch'|dim }} {{ render_user_avatar_20_and_link(ticket.get_user_manager()) }}</div>
      </td>
    </tr>
  </table>

{%- include 'ticketing_admin/_ticket_events.html' %}

{%- endblock %}

{% block scripts %}
<script>
  enableCopyToClipboard('ticket-id-copy-trigger');
</script>
{% endblock %}
